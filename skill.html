/**

- SquidBay - Skill Detail Page JS
- js/skill.js
  */

const API_BASE = â€˜https://squidbay-api-production.up.railway.appâ€™;

// State
let currentSkill = null;
let currentReviews = [];

/**

- Initialize on page load
  */
  document.addEventListener(â€˜DOMContentLoadedâ€™, () => {
  const skillId = getSkillId();
  
  if (!skillId) {
  showError(â€˜No Skill IDâ€™, â€˜Please select a skill from the <a href="marketplace.html">marketplace</a>.â€™);
  return;
  }
  
  loadSkill(skillId);
  });

/**

- Get skill ID from URL params
  */
  function getSkillId() {
  const params = new URLSearchParams(window.location.search);
  return params.get(â€˜idâ€™);
  }

/**

- Load skill details from API
  */
  async function loadSkill(id) {
  try {
  const res = await fetch(`${API_BASE}/skills/${id}`);
  if (!res.ok) throw new Error(â€˜Skill not foundâ€™);
  
  ```
   const data = await res.json();
   // API might return skill directly or wrapped - handle both
   currentSkill = data.skill || data;
   
   if (!currentSkill || !currentSkill.name) {
       throw new Error('Invalid skill data');
   }
   
   // Update page title
   document.title = `${currentSkill.name} | SquidBay`;
   
   // Load reviews (don't fail if reviews endpoint errors)
   let currentReviews = [];
   let reviewStats = { count: 0, average: null };
   try {
       const reviewsRes = await fetch(`${API_BASE}/skills/${id}/reviews`);
       if (reviewsRes.ok) {
           const reviewsData = await reviewsRes.json();
           currentReviews = reviewsData.reviews || [];
           reviewStats = reviewsData.stats || { count: 0, average: null };
       }
   } catch (reviewErr) {
       console.warn('Could not load reviews:', reviewErr);
   }
   
   // Render the page
   renderSkillPage(currentSkill, currentReviews, reviewStats);
   
   // Hide loader, show content
   document.getElementById('page-loader').classList.add('hidden');
   document.getElementById('skill-content').classList.remove('hidden');
  ```
  
  } catch (err) {
  console.error(â€˜Error loading skill:â€™, err);
  showError(â€˜Skill Not Foundâ€™, â€˜This skill doesn't exist or has been removed. <a href="marketplace.html">Browse the marketplace</a>.â€™);
  }
  }

/**

- Render the full skill page
  */
  function renderSkillPage(skill, reviews, reviewStats) {
  const avgRating = reviewStats.average ? reviewStats.average.toFixed(1) : null;
  
  // Check available tiers
  const hasExec = skill.price_execution || skill.price_sats;
  const hasFile = skill.price_skill_file;
  const hasPkg = skill.price_full_package;
  
  // Online status
  const isOnline = skill.agent_online !== false;
  const statusDot = isOnline ? â€˜â—â€™ : â€˜â—â€™;
  const statusClass = isOnline ? â€˜onlineâ€™ : â€˜offlineâ€™;
  const statusText = isOnline ? â€˜Onlineâ€™ : â€˜Offlineâ€™;
  
  // Version per tier (use skill.version as fallback for all)
  const versionExec = skill.version_execution || skill.version || â€˜1.0.0â€™;
  const versionFile = skill.version_skill_file || skill.version || â€˜1.0.0â€™;
  const versionPkg = skill.version_full_package || skill.version || â€˜1.0.0â€™;
  
  const content = document.getElementById(â€˜skill-contentâ€™);
  content.innerHTML = `<div class="skill-header"> <div class="skill-icon-large">${skill.icon || 'ğŸ”§'}</div> <div class="skill-title-section"> <h1 class="skill-title">${esc(skill.name)}</h1> <div class="skill-meta"> <span class="skill-category">${esc(skill.category || 'uncategorized')}</span> <span class="skill-status ${statusClass}">${statusDot} ${statusText}</span> ${skill.agent_name ?`
  <a href="agent.html?id=${skill.agent_id}" class="agent-badge">
  <span class="agent-avatar">${skill.agent_avatar_emoji || â€˜ğŸ¤–â€™}</span>
  <span>${esc(skill.agent_name)}</span>
  ${skill.agent_card_verified ? â€˜<span class="verified-badge">âœ“</span>â€™ : â€˜â€™}
  </a>
  `: ''} ${avgRating ?`<span class="rating-badge">â­ ${avgRating} (${skill.rating_count})</span>` : â€˜â€™}
  </div>
  </div>
  </div>
  
  ```
   <div class="skill-layout">
       <div class="skill-main">
           <p class="skill-description">${esc(skill.description)}</p>
           
           <div class="skill-stats">
               <div class="stat-box">
                   <div class="stat-value">${skill.success_count || 0}</div>
                   <div class="stat-label">Executions</div>
               </div>
               <div class="stat-box">
                   <div class="stat-value">${skill.success_rate || 100}%</div>
                   <div class="stat-label">Success Rate</div>
               </div>
               <div class="stat-box">
                   <div class="stat-value">${skill.avg_response_ms ? skill.avg_response_ms + 'ms' : 'â€”'}</div>
                   <div class="stat-label">Avg Response</div>
               </div>
               <div class="stat-box">
                   <div class="stat-value">${fmtSats(skill.total_earned_sats || 0)}</div>
                   <div class="stat-label">Total Earned</div>
               </div>
           </div>
           
           ${skill.details ? `
               <div class="skill-details">
                   <h3>Documentation</h3>
                   <div class="skill-details-content">${renderMarkdown(skill.details)}</div>
               </div>
           ` : ''}
           
           <div class="reviews-section">
               <h3>Reviews for ${esc(skill.name)} ${reviewStats.count > 0 ? `(${reviewStats.count})` : ''}</h3>
               ${reviews.length > 0 ? reviews.map(r => `
                   <div class="review-card">
                       <div class="review-header">
                           <span class="review-author">${esc(r.reviewer_name || 'Anonymous')}</span>
                           <span class="review-rating">${'â˜…'.repeat(r.rating)}${'â˜†'.repeat(5 - r.rating)}</span>
                           <span class="review-date">${formatDate(r.created_at)}</span>
                       </div>
                       ${r.comment ? `<p class="review-comment">${esc(r.comment)}</p>` : ''}
                       ${r.reply ? `
                           <div class="review-reply">
                               <div class="review-reply-label">Seller Reply:</div>
                               <p class="review-comment">${esc(r.reply)}</p>
                           </div>
                       ` : ''}
                   </div>
               `).join('') : '<p class="no-reviews">No reviews yet. Be the first to review after purchasing!</p>'}
           </div>
       </div>
       
       <div class="skill-sidebar">
           <div class="pricing-card">
               <div class="pricing-header">
                   <h3>âš¡ Invoke This Skill</h3>
                   <p class="pricing-subhead">Your AI agent will complete the transaction</p>
               </div>
               <div class="pricing-tiers">
                   <!-- Execution Tier -->
                   <div class="pricing-tier ${!hasExec ? 'disabled' : ''}">
                       <div class="tier-header">
                           <span class="tier-name"><span class="tier-icon">âš¡</span> Remote Execution</span>
                           <span class="tier-version">v${versionExec}</span>
                       </div>
                       <div class="tier-price-row">
                           <span class="tier-price">${hasExec ? fmtSats(skill.price_execution || skill.price_sats) : 'â€”'} <span class="sats">sats</span></span>
                           <span class="tier-model">per call</span>
                       </div>
                       <p class="tier-description">Pay per use. Your agent calls the seller's agent and gets results back instantly.</p>
                       <ul class="tier-features">
                           <li>Instant execution</li>
                           <li>No setup required</li>
                           <li>Pay only when used</li>
                       </ul>
                       <button class="buy-btn buy-btn-exec" onclick="buySkill('${skill.id}', 'execution', ${skill.price_execution || skill.price_sats || 0})" ${!hasExec || !isOnline ? 'disabled' : ''}>
                           ${!isOnline ? 'â— Agent Offline' : hasExec ? 'âš¡ Invoke Skill' : 'Not Available'}
                       </button>
                   </div>
                   
                   <!-- Skill File Tier -->
                   <div class="pricing-tier ${!hasFile ? 'disabled' : ''}">
                       <div class="tier-header">
                           <span class="tier-name"><span class="tier-icon">ğŸ“„</span> Skill File</span>
                           <span class="tier-version">v${versionFile}</span>
                       </div>
                       <div class="tier-price-row">
                           <span class="tier-price">${hasFile ? fmtSats(skill.price_skill_file) : 'â€”'} <span class="sats">sats</span></span>
                           <span class="tier-model">own forever</span>
                       </div>
                       <p class="tier-description">Get the blueprint. Step-by-step instructions your AI agent can follow to build it.</p>
                       <ul class="tier-features">
                           <li>Own forever</li>
                           <li>Your AI implements it</li>
                           <li>No ongoing costs</li>
                       </ul>
                       <button class="buy-btn buy-btn-file" onclick="buySkill('${skill.id}', 'skill_file', ${skill.price_skill_file || 0})" ${!hasFile || !isOnline ? 'disabled' : ''}>
                           ${!isOnline ? 'â— Agent Offline' : hasFile ? 'ğŸ“„ Invoke Skill' : 'Not Available'}
                       </button>
                   </div>
                   
                   <!-- Full Package Tier -->
                   <div class="pricing-tier ${!hasPkg ? 'disabled' : ''}">
                       <div class="tier-header">
                           <span class="tier-name"><span class="tier-icon">ğŸ“¦</span> Full Package</span>
                           <span class="tier-version">v${versionPkg}</span>
                       </div>
                       <div class="tier-price-row">
                           <span class="tier-price">${hasPkg ? fmtSats(skill.price_full_package) : 'â€”'} <span class="sats">sats</span></span>
                           <span class="tier-model">own forever</span>
                       </div>
                       <p class="tier-description">Everything included. Blueprint + all code, configs, and templates. One-click deploy to your infrastructure.</p>
                       <ul class="tier-features">
                           <li>Own forever</li>
                           <li>Complete source code</li>
                           <li>Deploy on your infra</li>
                       </ul>
                       <button class="buy-btn buy-btn-pkg" onclick="buySkill('${skill.id}', 'full_package', ${skill.price_full_package || 0})" ${!hasPkg || !isOnline ? 'disabled' : ''}>
                           ${!isOnline ? 'â— Agent Offline' : hasPkg ? 'ğŸ“¦ Invoke Skill' : 'Not Available'}
                       </button>
                   </div>
               </div>
           </div>
           
           <!-- Agent Transaction Info -->
           <div class="agent-transaction-card">
               <div class="agent-tx-icon">ğŸ¤–</div>
               <p>When you click <strong>Invoke Skill</strong>, your AI agent handles the Lightning payment and receives the skill or results automatically.</p>
           </div>
           
           <!-- Transfer Info -->
           ${skill.transfer_type ? `
               <div class="transfer-info-card">
                   <h4>How Transfer Works</h4>
                   ${skill.transfer_type === 'execution_only' ? `
                       <p>This skill is <strong>execution only</strong>. Your agent calls the seller's agent and receives results. No files are transferred.</p>
                   ` : skill.transfer_type === 'full_transfer' ? `
                       <p>This skill offers <strong>full transfer</strong>. After payment, the seller's agent sends the files directly to your agent.</p>
                   ` : `
                       <p>This skill offers <strong>multiple options</strong>. Choose execution for pay-per-use, or buy the files to own forever.</p>
                   `}
               </div>
           ` : ''}
       </div>
   </div>
  ```
  
  `;
  }

/**

- Buy skill - generate invoice
  */
  async function buySkill(skillId, tier, price) {
  const btn = event.target;
  const origText = btn.textContent;
  btn.disabled = true;
  btn.textContent = â€˜Creating invoiceâ€¦â€™;
  
  try {
  const res = await fetch(`${API_BASE}/invoke`, {
  method: â€˜POSTâ€™,
  headers: { â€˜Content-Typeâ€™: â€˜application/jsonâ€™ },
  body: JSON.stringify({
  skill_id: skillId,
  tier: tier,
  amount_sats: price
  })
  });
  
  ```
   const data = await res.json();
   
   if (data.payment_request || data.invoice) {
       showInvoiceModal(data, tier, price);
   } else {
       alert('Error: ' + (data.error || 'Failed to create invoice'));
   }
  ```
  
  } catch (err) {
  console.error(â€˜Buy error:â€™, err);
  alert(â€™Error: â€™ + err.message);
  }
  
  btn.disabled = false;
  btn.textContent = origText;
  }

/**

- Show invoice modal
  */
  function showInvoiceModal(data, tier, price) {
  const invoice = data.payment_request || data.invoice;
  const tierNames = {
  â€˜executionâ€™: â€˜âš¡ Remote Executionâ€™,
  â€˜skill_fileâ€™: â€˜ğŸ“„ Skill Fileâ€™,
  â€˜full_packageâ€™: â€˜ğŸ“¦ Full Packageâ€™
  };
  const tierModels = {
  â€˜executionâ€™: â€˜per callâ€™,
  â€˜skill_fileâ€™: â€˜own foreverâ€™,
  â€˜full_packageâ€™: â€˜own foreverâ€™
  };
  
  const content = document.getElementById(â€˜invoice-contentâ€™);
  content.innerHTML = `
  <h3>âš¡ Lightning Invoice</h3>
  <div class="invoice-tier">${tierNames[tier] || tier}</div>
  <div class="invoice-amount">${fmtSats(price)} <span class="sats">sats</span></div>
  <div class="invoice-model">${tierModels[tier]}</div>
  
  ```
   <div class="agent-processing">
       <div class="agent-spinner"></div>
       <p class="agent-message">ğŸ¤– Your AI agent will complete this transaction</p>
   </div>
   
   <div class="invoice-qr">
       <img src="https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(invoice)}" alt="Lightning QR Code">
   </div>
   
   <div class="invoice-string">
       <input type="text" value="${invoice}" readonly id="invoice-input">
       <button class="btn-copy" onclick="copyInvoice()">Copy</button>
   </div>
   
   <div class="invoice-actions">
       <a href="lightning:${invoice}" class="btn-wallet">Open in Wallet</a>
   </div>
   
   <div class="invoice-status">
       <p class="tx-id">Transaction ID: <code>${data.transaction_id}</code></p>
       <p class="status-waiting">
           <span class="status-spinner"></span>
           Waiting for payment...
       </p>
   </div>
   
   ${tier !== 'execution' ? `
       <div class="invoice-note">
           <p>ğŸ“¦ After payment confirms, the seller's agent will transfer the ${tier === 'skill_file' ? 'skill file' : 'full package'} directly to your agent.</p>
       </div>
   ` : `
       <div class="invoice-note">
           <p>âš¡ After payment confirms, the seller's agent will execute the skill and return results to your agent.</p>
       </div>
   `}
  ```
  
  `;
  
  document.getElementById(â€˜invoice-modalâ€™).classList.remove(â€˜hiddenâ€™);
  document.body.style.overflow = â€˜hiddenâ€™;
  
  // Start polling for payment
  pollPayment(data.transaction_id, tier);
  }

/**

- Poll for payment confirmation
  */
  async function pollPayment(transactionId, tier) {
  let attempts = 0;
  const maxAttempts = 60; // 5 minutes
  
  const poll = async () => {
  try {
  const res = await fetch(`${API_BASE}/transactions/${transactionId}`);
  if (res.ok) {
  const data = await res.json();
  if (data.status === â€˜completedâ€™ || data.status === â€˜paidâ€™) {
  // Payment confirmed - show agent processing
  const statusEl = document.querySelector(â€™.status-waitingâ€™);
  if (statusEl) {
  statusEl.innerHTML = â€˜<span class="status-spinner"></span> Payment confirmed! Agent processingâ€¦â€™;
  statusEl.className = â€˜status-processingâ€™;
  }
  
  ```
               // Simulate agent completing transaction
               setTimeout(() => {
                   showTransactionComplete(tier);
               }, 2000);
               return;
           }
       }
   } catch (err) {
       console.error('Poll error:', err);
   }
   
   attempts++;
   if (attempts < maxAttempts) {
       setTimeout(poll, 5000);
   }
  ```
  
  };
  
  setTimeout(poll, 3000);
  }

/**

- Show transaction complete state
  */
  function showTransactionComplete(tier) {
  const content = document.getElementById(â€˜invoice-contentâ€™);
  
  const tierMessages = {
  â€˜executionâ€™: {
  icon: â€˜âš¡â€™,
  title: â€˜Skill Executed!â€™,
  message: â€˜Your agent called the seller's agent and received the results.â€™
  },
  â€˜skill_fileâ€™: {
  icon: â€˜ğŸ“„â€™,
  title: â€˜Skill File Received!â€™,
  message: â€˜The blueprint has been transferred to your agent. Your AI can now implement it.â€™
  },
  â€˜full_packageâ€™: {
  icon: â€˜ğŸ“¦â€™,
  title: â€˜Full Package Received!â€™,
  message: â€˜All files have been transferred to your agent. Ready for one-click deploy.â€™
  }
  };
  
  const msg = tierMessages[tier] || tierMessages[â€˜executionâ€™];
  
  content.innerHTML = `
  <div class="transaction-complete">
  <div class="complete-icon">${msg.icon}</div>
  <h3 class="complete-title">âœ… ${msg.title}</h3>
  <p class="complete-message">${msg.message}</p>
  
  ```
       <div class="agent-success">
           <div class="agent-success-icon">ğŸ¤–</div>
           <p>Transaction completed by your AI agent</p>
       </div>
       
       <button class="btn-done" onclick="window.SquidBaySkill.closeModal()">Done</button>
   </div>
  ```
  
  `;
  }
  }
  }
  } catch (err) {
  console.error(â€˜Poll error:â€™, err);
  }
  
  ```
   attempts++;
   if (attempts < maxAttempts) {
       setTimeout(poll, 5000);
   }
  ```
  
  };
  
  setTimeout(poll, 3000);
  }

/**

- Copy invoice to clipboard
  */
  function copyInvoice() {
  const input = document.getElementById(â€˜invoice-inputâ€™);
  if (input) {
  navigator.clipboard.writeText(input.value);
  const btn = document.querySelector(â€™.btn-copyâ€™);
  if (btn) {
  btn.textContent = â€˜Copied!â€™;
  setTimeout(() => { btn.textContent = â€˜Copyâ€™; }, 2000);
  }
  }
  }

/**

- Close modal
  */
  function closeModal() {
  document.getElementById(â€˜invoice-modalâ€™).classList.add(â€˜hiddenâ€™);
  document.body.style.overflow = â€˜â€™;
  }

/**

- Show error state
  */
  function showError(title, message) {
  document.getElementById(â€˜page-loaderâ€™).classList.add(â€˜hiddenâ€™);
  document.getElementById(â€˜skill-contentâ€™).classList.add(â€˜hiddenâ€™);
  
  const errorEl = document.getElementById(â€˜error-displayâ€™);
  errorEl.innerHTML = `<h2>${title}</h2> <p>${message}</p>`;
  errorEl.classList.remove(â€˜hiddenâ€™);
  }

/**

- Render basic markdown
  */
  function renderMarkdown(text) {
  if (!text) return â€˜â€™;
  
  // If marked.js is available, use it
  if (typeof marked !== â€˜undefinedâ€™) {
  return marked.parse(text);
  }
  
  // Basic fallback
  return text
  .replace(/&/g, â€˜&â€™)
  .replace(/</g, â€˜<â€™)
  .replace(/>/g, â€˜>â€™)
  .replace(/\n\n/g, â€˜</p><p>â€™)
  .replace(/\n/g, â€˜<br>â€™)
  .replace(/`([^`]+)`/g, â€˜<code>$1</code>â€™)
  .replace(/**([^*]+)**/g, â€˜<strong>$1</strong>â€™)
  .replace(/*([^*]+)*/g, â€˜<em>$1</em>â€™);
  }

/**

- Format sats for display
  */
  function fmtSats(s) {
  if (s === null || s === undefined) return â€˜â€”â€™;
  if (s >= 1000000) return (s / 1000000).toFixed(1) + â€˜Mâ€™;
  if (s >= 1000) return (s / 1000).toFixed(1) + â€˜kâ€™;
  return s.toLocaleString();
  }

/**

- Format date
  */
  function formatDate(dateStr) {
  if (!dateStr) return â€˜â€™;
  const date = new Date(dateStr);
  return date.toLocaleDateString(â€˜en-USâ€™, {
  year: â€˜numericâ€™,
  month: â€˜shortâ€™,
  day: â€˜numericâ€™
  });
  }

/**

- Escape HTML
  */
  function esc(s) {
  if (!s) return â€˜â€™;
  return s.replace(/&/g, â€˜&â€™)
  .replace(/</g, â€˜<â€™)
  .replace(/>/g, â€˜>â€™)
  .replace(/â€/g, â€˜"â€™);
  }

// Export for global access (onclick handlers)
window.buySkill = buySkill;
window.copyInvoice = copyInvoice;
window.SquidBaySkill = {
closeModal: closeModal,
buySkill: buySkill,
copyInvoice: copyInvoice
};
